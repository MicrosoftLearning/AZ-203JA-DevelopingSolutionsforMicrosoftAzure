---
lab:
    title: 'ラボ: Azure にデプロイされた監視サービス'
    type: 'Answer Key'
    module: 'モジュール 5: Azure ソリューションの監視、トラブルシューティング、最適化を行う'
---

# ラボ: Azure にデプロイされた監視サービス
# 受講ラボの解答キー

## Microsoft Azure ユーザー インターフェイス

Microsoft クラウド ツールのダイナミックな性質を考えると、このトレーニング コンテンツの開発後に Azure ユーザー インターフェイス (UI) の変更が発生する可能性があります。これらの変更により、演習の手順と手順が一致しない場合があります。

Microsoft は、コミュニティが必要な変更を行うとすぐに、このトレーニング コースを更新します。しかし、クラウド更新が頻繁に起きるため、この研修内容が更新される前に、UI の変更を経験するかも知れません。 **その場合は変更に順応して、必要に応じてラボでをそれを処理してください。**

## 指示

### 開始する前に

#### ラボの仮想マシンへのサインイン

  - 次の認証情報を使用して **Windows 10** 仮想マシンにサインインします。
    
      - **ユーザー名**： Admin
    
      - **パスワード**: Pa55w.rd

> > **注記**： ラボ仮想マシンのサインイン手順は、インストラクターから提供されます。

#### インストールされたアプリケーションの検討

  - **Windows 10** デスクトップの下部にあるタスク バーを確認します。タスク バーには、このラボで使用するアプリケーションのアイコンが含まれています。
    
      - Microsoft Edge
    
      - エクスプローラ
    
      - Visual Studio Code:
    
      - Windows PowerShell

#### 練習用ファイルをダウンロードする

1.  タスク バーで、 **Windows PowerShell** アイコンを選択します。

2.  PowerShell コマンド プロンプトで、現在の作業ディレクトリを **Allfiles (F):\\** パスに変更します。

    ```
    cd F:
    ```

3.  コマンド プロンプト内で次のコマンドを入力し、Enter キーを押して、GitHub でホストされている **Microsoftlearning/AZ-203-DevelopingSolutionsForAzure** プロジェクトを  **Labfiles** ディレクトリに複製します。

    ```
    git clone --depth 1 --no-checkout https://github.com/microsoftlearning/AZ-203-DevelopingSolutionsForMicrosoftAzure .
    ```

4.  コマンド プロンプト内で次のコマンドを入力し、**Enter** キーを押 して、**AZ-203.02** ラボを完了するために必要なラボ ファイルをチェックアウトします。

    ```
    git checkout master -- Allfiles/*
    ```

5.  現在実行中の **Windows PowerShell** コマンド プロンプト アプリケーションを閉じます。

### エクササイズ 1: Azure リソースの作成と構成

#### タスク 1: Azure potalを開く

1.  タスク バーで、**Microsoft Edge** アイコンを選択します。

2.  開いているブラウザ ウィンドウで、[**Azure potal**](https://portal.azure.com)(portal.azure.com)に移動します。

3.  サインイン ページで、Microsoft アカウントの **電子メール アドレス** を入力します。

4.  **次へ** を選択します。

5.  Microsoft アカウントの **パスワード** を入力します。

6.  **サインイン** を選択します。

> **注記**： **Azure potal** に初めてサインインする場合は、ダイアログ ボックスにポータルを見学するオファーが表示されます。  ツアーをスキップしてポータルの使用を開始するには、 **開始** を選択します。

#### タスク 2: アプリケーション インサイト リソースを作成します。

1.  ポータルの左側のナビゲーション ウィンドウで、**+ リソースを作成** を選択します。

2.  **新規** ブレードの上部にある **マーケットプレースを検索** フィールドを検索します。   

3.  検索フィールドに **インサイト** と入力し、Enterを押します。 

4.  **すべての** 検索結果ブレードで、 **アプリケーションインサイト** の結果を選択します。 

5.  **アプリケーションインサイト** ブレードで、 **作成** を選択します。   

6.  2番目の **アプリケーション インサイト** ブレードで、次の操作を実行します。 
    
    1.  **名前** フィールド **に、instrm\[*名前を小文字*\]** と入力します。 
    
    2.  **アプリケーションの種類** ボックスの一覧で、**ASP.NETウェブアプリケーション** を選択します。
    
    3.  **サブスクリプション** フィールドは既定値に設定したままにします。 
    
    4.  **リソース グループ** セクションで、 **新規作成** を選択し、 **監視対象資産** を入力します。   
    
    5.  **場所** リストで、 **米国東部** リージョンを選択します。
    
    6.  **作成** を選択します。

7.  演習を進める前に、作成タスクが完了するまで待ちます。

8.  ポータルの左側のナビゲーション ウインドウで、**リソース グループ** を選択します。 

9.  **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを選択します。  

10. **MonitoredAssets** ブレードで、この実習ラボで前に作成した **instrm\*** アプリケーション インサイト アカウントを選択します。  

11. **アプリケーション インサイト** ブレードで、ブレードの左側の **構成** カテゴリ内で、 **プロパティ** リンクを選択します。     

12. **プロパティ** セクションで、**インストルメンテーション キー** フィールドの値を確認します。 このキーは、クライアント アプリケーションによって Application Insights に接続するために使われます。

#### タスク 3: API アプリ リソースの作成

1.  ポータルの左側のナビゲーション ウィンドウで、 **+ リソースを作成** を選択します。

2.  **新規** ブレードの上部にある **マーケットプレースを検索** フィールドを検索します。

3.  検索フィールドに **API** を入力し、Enter キーを押します。 

4.  **すべての** 検索結果ブレードで、 **API アプリ** の結果を選択します。

5.  **API アプリ** ブレードで、**作成** を選択します。

6.  2番目の **API アプリ** ブレードで、次のアクションを実行します。 
    
    1.  **アプリ名** フィールドに、**smpapi\[*名前を小文字*\]** と入力します。 
    
    2.  **サブスクリプション** フィールドは既定値に設定したままにします。
    
    3.  **リソース グループ** セクションで、**既存のものを使用** を選択し、**MonitoredAssets** を選択します。   
    
    4.  **App Services  プラン/場所**フィールドを選択します。 

7.  **App Services 計画** ブレードで、**新規作成** を選択します。 

8.  **新しいApp Services プラン** ブレードで、次の操作を実行します。 
    
    5.  **App Services プラン** フィールドに、**MonitoredPlan** と入力します。 
    
    6.  **場所** リストで、**米国東部** の場所を選択します。 
    
    7.  **価格レベル** フィールドを値 **(S1)** に設定します。   
    
    8.  **OK** を選択します。

9.  **Api アプリ** ブレードに戻り、**アプリケーションインサイト** フィールドを選択します。   

10. **アプリケーション インサイト** ブレードで、次の操作を実行します。 
    
    9.  **アプリケーション インサイト サイト拡張機能** セクションで、**有効にする** を選択します。 
    
    10. **アプリケーションインサイト リソースへのリンク** セクションで、**既存のリソースを選択** を選択し、この実習ラボで前に作成した **instrm\*** アプリケーション インサイト アカウントを選択します。   
    
    11. **アプリケーションをインストゥルメント** セクションで **NET コア** タブを選択し、 **推奨** を選択します。
    
    12. **適用** を選択します。

11. **Api アプリ** ブレードに戻る場合は、 **作成** を選択します。   

12. 演習を進める前に、作成タスクが完了するまで待ちます。

13. ポータルの左側のナビゲーション ウインドウで、 **リソース グループ** を選択します。

14. **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを選択します。

15. **MonitoredAssets** ブレードで、 この実習ラボで前に作成した **smpapi\*** API アプリを選択します。  

16. **App Services ** ブレードで、ブレードの左側にある **設定** カテゴリ内で、**アプリケーション設定** リンクを選択します。   

17. **アプリケーション設定** セクションで、APIの **アプリケーション設定** の一覧が表示されるまで下にスクロールします。

18. APIに関連付けられているシークレットを表示するには、 **値を表示** を選択します。

19. **APPINSIGHTS\_インストルメンテーションキー** キーに対応する値を確認します。 この値は、API アプリ リソースの構築時に自動的に設定されました。

20. **App Services ** ブレードで、 **設定** カテゴリ内のブレードの左側 で、 **プロパティ** リンクを選択 します。

21. **プロパティ** セクションで、 **URL** フィールドの値を記録します。 この値は、ラボの後半でこの値を使用して、API に対する要求を行います。

#### タスク 4: API アプリの自動スケール オプションを構成する

1.  **App Services** ブレードで、ブレードの左側にある **設定** カテゴリ内で **スケール アウト** リンクを選択します。   

2.  **スケール アウト** セクションで、次の操作を実行します。 
    
    1.  **編集を有効にする** を選択する
    
    2.  **自動スケール設定名** フィールドに、**ComputeScaler** と入力 します。
    
    3.  **リソース グループ** の一覧で、**監視対象資産** を選択します。   
    
    4.  **縮尺モード** セクションで、**メトリックに基づくスケール** を選択します。   
    
    5.  **インスタンスの制限** セクション内の **最小** フィールドに、**2** と入力します。
    
    6.  **インスタンスの制限** セクション内の **最大** フィールドに、 **8** と入力します。
    
    7.  **インスタンスの制限** セクション内の **既定** フィールドで、 **3** と入力します。
    
    8.  **+ 規則の追加** を選択します。表示される **縮尺 ルール** ウインドウで、すべてのフィールドを既定値に設定したままにし、 **追加** を選択します。   
    
    9.  ページの上部にある **保存** をクリックします。

3.  この演習を進める前に、保存操作が完了するのを待ちます。

#### 復習

この演習では、演習の残りの部分で使用するリソースを作成しました。

### エクササイズ 2: ASP.NETコアWeb API アプリケーションの構築とデプロイ

#### タスク 1: .NET Core Web API プロジェクトの構築

1.  タスク バーで、 **Visual Studio コード** アイコンを選択します。

2.  **ファイル** メニューで、 **フォルダを開く** を選択します。   

3.  開くファイル エクスプローラ ウインドウで、 **すべてのファイル (F):Labfiles\\05\\Starter\\Api** に移動し、 **フォルダの選択** を選択します。

4.  Visual Studio コード ウインドウで、コンテキスト メニューにアクセスするか、 **エクスプローラ** ペインを右クリックし、 **ターミナルで開く** を選択します。

5.  openコマンド プロンプトで次のコマンドを入力し、Enterキーを押して現在のディレクトリに **SimpleApi** という名前の新しいNET Core Web API アプリケーションを作成します。

dotnet new webapi --output .--name SimpleApi

6.  コマンド プロンプトで、次のコマンドを入力し、Enter キーを押して、NuGet から現在のプロジェクトに **Microsoft.ApplicationInsights.AspNetCore** パッケージの **2.6.1** バージョンを追加します。

dotnet add package Microsoft.ApplicationInsights.AspNetCore --version 2.6.1

7.  コマンド プロンプトで次のコマンドを入力し、Enter キーを押して NET Core Web アプリケーションをビルドします。

dotnet build

#### タスク 2: HTTPS を無効にしてアプリケーション インサイトを使用するようにアプリケーション コードを更新する

1.  **Visual Studio コード** ウインドウの左側にある **エクスプローラ** ペインで、**Program.cs** ファイルをダブルクリックしてエディタでファイルを開きます。   

2.  エディタの **Program** クラスで、次のコード ブロックを **20** 行目で見つけます。

public static IWebHostBuilder CreateWebHostBuilder(string\[\] args) =\>

WebHost.CreateDefaultBuilder(args)

.UseStartup\<Startup\>();

3.  プロジェクトの **アプリケーション インサイト** テレメトリを有効にする次のコード ブロックに、そのコード ブロックを置き換えます。

public static IWebHostBuilder CreateWebHostBuilder(string\[\] args) =\>

WebHost.CreateDefaultBuilder(args)

.UseStartup\<Startup\>()

.UseApplicationInsights();

4.  **Program.cs** ファイルを **保存** します。

5.  **Visual Studio コード** ウインドウの左側にある **エクスプローラ** ウインドウで、**Startup.cs** ファイルをダブルクリックしてエディタでファイルを開きます。     

6.  エディタの **Program** クラスで、**44** 行の次のコード行を検索して削除します。 

app.UseHttpsRedirection();

> > **注記**： このコード行は、API アプリにHTTPSを強制的に使用します。この演習では、これは不要です。

7.  **Startup.cs** ファイルを **保存** します。

<!-- end list -->

8.  画面の下部にあるコマンド プロンプトに注目してください。コマンド プロンプトで次のコマンドを入力し、Enter キーを押して.NET Core Webアプリケーションをビルドします。

dotnet build

#### タスク 3: API アプリケーションをローカルでテスト

1.  画面の下部にあるコマンド プロンプトに注目してください。コマンド プロンプトで次のコマンドを入力し、Enter キーを押して.NET Core Webアプリケーションを実行します。

dotnet run

2.  タスク バーで、**Microsoft Edge** アイコンを選択します。

3.  開いているブラウザ ウインドウで、ポート **5000** の **localhost** でホストされているテスト アプリケーションの **/api/values** 相対パスに移動します。
    
    **注記**： 完全なURLはhttp://localhost:5000/api/values です

4.  同じブラウザ ウインドウで、ポート **5000** の **localhost** でホストされているテスト アプリケーションの **/api/values/7** 相対パスに移動します。
    
    **注記**：完全なURLはhttp://localhost:5000/api/values/7 です。

5.  http://localhost:5000/api/values/7 アドレスを表示するブラウザウインドウを閉じます。

6.  現在実行中の **Visual Studio Code** アプリケーションを閉じます。

#### タスク 4: アプリケーション インサイトでのメトリックの表示

1.  **Azure potal** を表示する、現在開いているブラウザ ウインドウに戻ります。

2.  ポータルの左側で、**リソース グループ** を選択します。

3.  **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを見つけて選択します。 

4.  **MonitoredAssets** ブレードで、この実習ラボで前に作成した**instrm\*** アプリケーション インサイト アカウントを選択します。

5.  **アプリケーション インサイト** ブレードにおいて、ブレードの中央にあるタイルで、表示されるメトリックを確認します。 具体的には、発生した **サーバー** **要求** の数と平均 **サーバー応答時間** を確認します。     

#### タスク 5: API アプリにアプリケーションをデプロイする

1.  タスク バーで、**Visual Studio コード** アイコンを選択します。

2.  **ファイル** メニューで、 **フォルダを開く** を選択します。

3.  開くファイル エクスプローラ ウインドウで、 **すべてのファイル (F):Labfiles\\StarterAPI** に移動し、 **フォルダの選択** を選択します。

4.  Visual Studio コード ウインドウで、コンテキスト メニューにアクセスするか、 **エクスプローラ** ペインを右クリックし、 **ターミナルで開く** を選択します。

5.  openコマンド プロンプトで次のコマンドを入力し、Enterキーを押して Azure CLI にサインインします。

az login

6.  表示されるブラウザー ウィンドウで、次の操作を実行します：
    
    1.  Microsoft アカウントの **電子メール アドレス** を入力します。
    
    2.  **次へ** を選択します。
    
    3.  Microsoft アカウントの **パスワード** を入力します。 
    
    4.  **サインイン** を選択します。

7.  現在開いている **コマンド プロンプト** アプリケーションに戻ります。 サインイン プロセスが完了するのを待ちます。

8.  コマンド プロンプトで次のコマンドを入力し、Enterキーを押して、 **MonitoredAssets** リソース グループ内のすべての **アプリ** を一覧表示します。

az webapp list --resource-group MonitoredAssets

9.  次のコマンドを入力し、Enterキーを押すと、プレフィックス **smpapi\*** を持つ **アプリ** が見つかります。

az webapp list --resource-group MonitoredAssets --query "\[?starts\_with(name, 'smpapi')\]"

10. 次のコマンドを入力し、Enter キーを押して、プレフィックス **smpapi\*** を持つ単一のアプリの名前のみを印刷します。

az webapp list --resource-group MonitoredAssets --query "\[?starts\_with(name, 'smpapi')\].{Name:name}" --output tsv

11. 次のコマンドを入力し、Enter キーを押して現在のディレクトリを、デプロイファイルを含む **すべてのファイル に変更します(F):LABfiles\\05\\Starter** ディレクトリに変更します。 

cd F:\\Labfiles\\05\\Starter\\

12. 次のコマンドを入力し、Enterキーを押して、この実習ラボで作成済みの **API アプリ** に **api.zip** ファイルをデプロイします。

az webapp deployment source config-zip --resource-group MonitoredAssets --src api.zip --name \<name-of-your-api-app\>

> > **注記**： この演習で前に作成したAPI アプリの名前に、 **\<api-appの名前\>** プレースホルダを置き換えます。このアプリ名は、以前のステップで最近クエリしました。

13. この演習を進める前に、展開が完了するのを待ちます。

14. 現在実行中の **Visual Studio Code** アプリケーションを閉じます。

15. ポータルの左側のナビゲーション ウインドウで、 **リソース グループ** を選択します。

16. **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを選択します。

17. **MonitoredAssets** ブレードで、 この実習ラボで前に作成した **smpapi\*** API アプリを選択します。

18. **App Services ** ブレードで、ブレードの上部にある **参照** を選択します。 

19. 新しいブラウザ ウインドウまたはタブが開き、**404 (見つかりません)** エラーが返されます。ブラウザのアドレス バーで、現在のURLの末尾にサフィックス **/api/値** を追加してURL を更新し、Enterキーを押します。

> > **注記**： たとえば、URL がhttp://smpapistudent.azurewebsites.net の場合、新しい URL はhttp://smpapistudent.azurewebsites.net/api/values となります。

20. API を使用した結果として返される JSON 配列を観察します。

#### 復習

この演習では、ASP.NET Core を使用してAPIを作成し、アプリケーション メトリックをアプリケーション インサイトにストリーミングするように構成しました。次に、アプリケーション インサイト ダッシュボードを使用して、API アプリとアプリで実行されている API に関するパフォーマンスの詳細を表示しました。

### エクササイズ 3: .NET Core を使ったクライアント アプリケーションの構築

#### タスク 1: .NET Core コンソール プロジェクトの構築

1.  タスク バーで、**Visual Studio コード** アイコンを選択します。

2.  **ファイル** メニューで、 **フォルダを開く** を選択します。

3.  開くファイル エクスプローラ ウインドウで、 **すべてのファイル (F):Labfiles\\Starterコンソール** に移動し、 **フォルダの選択** を選択します。

4.  Visual Studio コード ウインドウで、コンテキスト メニューにアクセスするか、 **エクスプローラ** ペインを右クリックし、 **ターミナルで開く** を選択します。

5.  open コマンド プロンプトで、次のコマンドを入力し、Enter キーを押して、現在の ディレクトリに **SimpleConsole** という名前の新しい .NET Core コンソール アプリケーションを作成します。

dotnet new console --output .--name SimpleConsole

6.  コマンド プロンプトで次のコマンドを入力し、Enterキーを押して、NuGetから現在のプロジェクトに **Microsoft.Net.Http** パッケージの **2.2.29** バージョンを追加します。

dotnet add package Microsoft.Net.Http --version 2.2.29

7.  コマンド プロンプトで次のコマンドを入力し、Enterキーを押してNuGetから **Polly パッケージの** 7.0.2 **バージョンを** 現在のプロジェクトに追加します。

dotnet add package Polly --version 7.0.2

8.  コマンド プロンプトで次のコマンドを入力し、Enterキーを押してNET Core Webアプリケーションをビルドします。

dotnet build

#### タスク 2: HTTPクライアント コードの追加

1.  **Visual Studio コード** ウインドウの左側にある **エクスプローラ** ペインで、**Program.cs** ファイルをダブルクリックしてエディタでファイルを開きます。

2.  エディタ で、**System.Net.Http** 名前空間の次の **using** ブロックを追加 します。   

using System.Net.Http;

3.  エディタで、**System.Threading.Tasks** 名前空間の次の **using** ロック を追加します。   

System.Threading.Tasks を使用します；

4.  **SimpleConsole** の名前空間で、次のクラスを **7** 行目で見つけます。 

class Program

{

static void Main(string\[\] args)

{

Console.WriteLine("Hello World\!");

}

}

5.  **プログラム** クラス全体を次の実装に置き換えます。

class Program

{

private const string \_api = "";

private static HttpClient \_client = new HttpClient(){ BaseAddress = new Uri(\_api) };

static void Main(string\[\] args)

{

Run().Wait();

}

static async Task Run()

{

}

}

6.  **9** 行目で **\_api** 定数を見つけます:

private const string \_api = "";

7.  この演習で前に記録したAPI アプリの **URL** に変数の値を設定して、 **\_api** 定数を更新します。

> > **注記**： たとえば、URL がhttp://smpapistudent.azurewebsites.net の場合、新しいコード行は次のようになります: プライベート const 文字列 \_api =  "http://smpapistudent.azurewebsites.net"。

8.  **Run** メソッド内で、次のコード行を追加して、 **/api/values/** の相対パスに対して文字列を渡す **HttpClient.GetStringAsync** メソッドを非同期的に呼び出します。 

string response = await \_client.GetStringAsync("/api/values/");

9.  **Run** メソッド内で、**GET** 要求からの応答をコンソールに書き出すコード行を追加します。

Console.WriteLine(response);

10. **Program.cs** ファイルには、次のコードが必要です。 

using System;

using System.Net.Http;

System.Threading.Tasks を使用します；

namespace SimpleConsole

{

class Program

{

private const string \_api = "http://\<your-api-name\>.azurewebsites.net ";

private static HttpClient \_client = new HttpClient(){ BaseAddress = new Uri(\_api) };

static void Main(string\[\] args)

{

Run().Wait();

}

static async Task Run()

{

string response = await \_client.GetStringAsync("/api/values/");

Console.WriteLine(response);

}

}

}

11. **Program.cs** ファイルを**保存**します。

#### タスク 3: コンソール アプリケーションをローカルでテストする

1.  画面の下部にあるコマンド プロンプトで次のコマンドを入力し、Enterキーを押して .NET Core Web アプリケーションを実行します。

dotnet run

2.  アプリケーションがAzureでAPI アプリを正常に呼び出し、この実習で前に説明したのと同じJSONアレイを返すことに注意してください。結果は、次のJSONコンテンツと同様に表示されます。

\["value1","value2"\]

3.  **Azure potal** を表示する、現在開いているブラウザ ウインドウに戻ります。

4.  ポータルの左側で、**リソース グループ** を選択します。

5.  **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを見つけて選択します。

6.  **MonitoredAssets** ブレードで、 この実習ラボで前に作成した **smpapi\*** API アプリを選択します。

7.  **App Services** ブレードで、ブレードの上の **停止** を選択してAPI アプリの実施を停止します。

8.  **Web アプリの停止** 確認ダイアログ ボックスで **はい** を選択します。

9.  タスク バーで、 **Visual Studio コード** アイコンを選択します。

10. **ファイル** メニューで、 **フォルダを開く** を選択します。

11. 開くファイル エクスプローラ ウインドウで、 **すべてのファイル (F):Labfiles\\Starterコンソール** に移動し、 **フォルダの選択** を選択します。

12. Visual Studio コード ウインドウで、コンテキスト メニューにアクセスするか、 **エクスプローラ** ペインを右クリックし、 **ターミナルで開く** を選択します。

13. open コマンド プロンプトで次のコマンドを入力し、Enterキーを押して.NET Core Webアプリケーションを実行します。

dotnet run

14. アプリケーションの実行が失敗し、次の例外メッセージに似た **HttpRequestException** メッセージが表示されます。

System.Net.Http.HttpRequestException: 応答ステータス コードは示しません

成功：403 (サイトが無効)。

at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()

at System.Net.Http.HttpClient.GetStringAsyncCore(Task\`1 getTask)

at SimpleConsole.Program.Run() in F:\\Labfiles\\Starter\\Console\\Program.cs:line 20

> > **注記**：この例外は、API アプリが使用できなくなったために発生します。

#### タスク 4: Pollyを使用して再試行ロジックを追加する

1.  **Visual Studio コード** ウインドウの左側にある **エクスプローラ** ウインドウで、**PollyHandler.cs** ファイルをダブル クリックしてエディタでファイルを開きます。     

2.  **PollyHandler** クラス内で、**13～24** 行目を確認します。 これらのコード行は、**NET Foundation** の **Polly** ライブラリを使用して、失敗した HTTP 要求を5分ごとに再試行する再試行ポリシーを作成します。   

3.  **Visual Studio コード** ウインドウの左側にある **エクスプローラ** ペインで、 **Program.cs** ファイルをダブルクリックしてエディタでファイルを開きます。

4.  **10** 行目で **\_client** 定数を見つける: 

private static HttpClient \_client = new HttpClient(){ BaseAddress = new Uri(\_api) };

5.  **PollyHandler** クラスの新しいインスタンスを使用するように **HttpClient** コンストラクタを更新して **\_client** 定数を更新します。 

private static HttpClient \_client = new HttpClient(new PollyHandler()){ BaseAddress = new Uri(\_api) };

6.  **Program.cs** ファイルを **保存** します。

#### タスク 5: 再試行ロジックの検証

1.  画面の下部にあるコマンド プロンプトで次のコマンドを入力し、Enterキーを押して .NET Core Web アプリケーションを実行します。

dotnet run

2.  HTTP要求の実行は引き続き失敗し、5秒ごとに再試行されます。アプリケーションの障害が発生している間は、コンソールで次のメッセージが表示されます。

試行に失敗しました

3.  コンソールアプリケーションを実行したままにします。API アプリが成功するまで、API アプリに無限にアクセスしようとします。

4.  **Azure potal** を表示する、現在開いているブラウザ ウインドウに戻ります。

5.  ポータルの左側で、 **リソース グループ** を選択します。

6.  **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを見つけて選択します。

7.  **MonitoredAssets** ブレードで、 この実習ラボで前に作成した **smpapi\*** API アプリを選択します。

8.  **App Services** ブレードで、ブレードの上の **開始** を選択してAPI アプリの実施を再開します。

9.  **Web アプリの停止** 確認ダイアログ ボックスで **はい** を選択します。

10. 現在実行中の **Visual Studio Code** アプリケーションに戻ります。

11. アプリケーションが最終的にAzureでAPI アプリを正常に呼び出し、この実習で前に説明したのと同じJSONアレイを返すことに注意してください。結果は、次のJSONコンテンツのようになります。

\["value1","value2"\]

12. 現在実行中の **Visual Studio Code** アプリケーションを閉じます。

#### 復習

この演習では、条件付き再試行ロジックを使用してAPIにアクセスするコンソール アプリケーションを作成しました。API アプリが利用可能かどうかにかかわらず、アプリケーションは引き続き動作します。

### エクササイズ 4: テスト API アプリの読み込み

#### タスク 1: API アプリでパフォーマンス テストを実行する

1.  **Azure potal** を表示する、現在開いているブラウザ ウインドウに戻ります。

2.  ポータルの左側で、 **リソース グループ** を選択します。

3.  **リソース グループ** ブレードで、 この実習ラボで前に作成した **MonitoredAssets** リソース グループを見つけて選択します。

4.  **MonitoredAssets** ブレードで、 この実習ラボで前に作成した **smpapi\*** API アプリを選択します。

<!-- end list -->

4.  **App Services** ブレードで、**開発ツール** カテゴリ内のブレードの左側で、 **パフォーマンス テスト** を選択します。     

<!-- end list -->

5.  **パフォーマンス テスト** セクションの上部にある **新規** を選択します。 

6.  **新しいパフォーマンス テスト** ブレードで、次の操作を実行します。 
    
    1.  **名前** フィールドに **LoadTest** と入力します。   
    
    2.  **読み込み元の生成** リストで、 **米国東部 (Web アプリの場所)** を選択します。
    
    3.  **経費の合計** フィールドで、 **1000** と入力します。
    
    4.  **期間** フィールドに、 **10** と入力します。   
    
    5.  **使用してテストを構成する** を選択します。 

7.  **使用したテストを構成する** ブレードで、次の操作を実行します。 
    
    6.  **テストの種類** の一覧で、 **手動テスト** を選択します。   
    
    7.  **URL** フィールドで、サフィックス **/api/値** を現在のURLの末尾に追加してURLを更新します。 

> > **注記**： たとえば、URL がhttp://smpapistudent.azurewebsites.net の場合、新しい URL はhttp://smpapistudent.azurewebsites.net/api/values となります。

8.  **完了** を選択します。 

<!-- end list -->

8.  **新しいパフォーマンス テスト** ブレードに戻り、 **テストの実行** を選択します。   

9.  **パフォーマンス テスト** セクションに戻り、**最近の実行** の一覧で、 **LoadTest** を選択します。     

10. **LoadTest** ブレードで、テストが開始されるのを待ってから、演習を続行します。

> > **注記**： ほとんどのロード テストでは、リソースの収集と開始に約10～15分かかります。ロード テストが開始されると自動的にリフレッシュするので、このブレードで待てます。

11. ロード テストが完了するのを待ってから、演習を続行します。API アプリの使用率が増加するにつれて、ライブ チャートの更新に注意してください。

> > **注記**： ロード テストには、演習の前の手順で指定した10分かかります。

#### タスク 2: パフォーマンス テスト後にAzure モニタのメトリックを使用する

1.  Azureポータルの左のナビゲーション ペインで、 **すべてのサービス** をクリックします。

2.  **すべてのサービス** ブレードで、**モニタ** を選択します。

3.  **モニタ** ブレードの左側で、 **メトリック** を選択します。   

4.  **メトリック** セクションで、次の操作を実行します。
    
    1.  **リソース** セクションで、 **リソースを選択** を選択します。 
    
    2.  **リソース グループ** リストで表示される** リソースの選択** ウインドウで **MonitoredAssets** を選択します。 次に、**リソース** リストで、**instrm\*** アプリケーション インサイト アカウント オプションを選択します。 最後に、 **適用** を選択してウインドウを閉じ、選択内容を確認します。 
    
    3.  **標準** カテゴリの **メトリック名前空間** リストで、 **標準メトリック** を選択します。     
    
    4.  **メトリック** リストで、 **パフォーマンス カウンタ** カテゴリで **CPUの処理** を選択します。     
    
    5.  **集合** リストで **平均** を選択します。
    
    6.  セクションの上部で、**過去24時間 (自動)** を選択します。  表示されるウインドウで **時間範囲** カテゴリで **過去30分** を 選択し、**適用** を選択して選択範囲を保存します。     
    
    7.  セクションの上部で、**ライン チャート** を選択します。  表示されるメニューで、 **面グラフ** を選択します。 

5.  新しく作成したグラフを確認します。

6.  セクションの上部で、 **メトリックを追加** を選択します。

7.  **メトリック** セクションで、リスト内の新しいメトリック項目を使用して次のアクションを実行します。 
    
    8.  **標準** カテゴリの **メトリック名前空間** リストで、 **ログベースのメトリック** を選択します。    
    
    9.  **サーバー** カテゴリの **メトリック** ボックスで、 **サーバー応答時間** を選択します。
    
    10. **集合** リストで **平均** を選択します。

8.  更新されたグラフを確認します。グラフに表示される情報を確認します。アプリケーションの負荷が増大するにつれて、サーバーの応答時間と CPU 時間との相関関係を確認できます。

#### 復習

この演習では、Azureで使用できるツールを使用して、API アプリのパフォーマンス（読み込み）テストを実行しました。ロード テストを実行した後、Azure Monitorインターフェイスでメトリックを使用してAPI アプリの動作を測定できます。

### エクササイズ 5: サブスクリプションのクリーンアップ 

#### タスク 1: Cloud Shell を開く

1.  Azure potalの上部で、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。

2.  **Cloud Shell** コマンド プロンプトのポータルの下部にある次のコマンドを入力し、Enter キーを押してサブスクリプション内のすべてのリソース グループを一覧表示します。

az group list

3.  次のコマンドを入力し、Enter キーを押して、リソース グループを削除する可能性のあるコマンドの一覧を表示します。

az group delete --help

#### タスク 2: リソース グループを削除する

1.  次のコマンドを入力し、Enter キーを押して **MonitoredAssets** リソース グループを削除します。

az group delete --name MonitoredAssets --no-wait --yes

2.  ポータルの下部にある **Cloud Shell** ペインを閉じます。

#### タスク 3: アクティブなアプリケーションを閉じる

1.  現在実行中の **Microsoft Edge** アプリケーションを閉じます。

2.  現在実行中の **Visual Studio Code** アプリケーションを閉じます。

#### 復習

この実習では、この演習で使用する **リソース グループ** を削除してサブスクリプションをクリーンアップしました。
